# Example Traefik Dynamic Configuration
# This file shows how to configure the TOTP authentication plugin

http:
  middlewares:
    # Basic TOTP authentication
    totp-basic:
      plugin:
        totp-auth:
          secretKey: "JBSWY3DPEHPK3PXP"  # Replace with your secret
          sessionExpiry: 3600
          issuer: "MyApp"
          accountName: "user@example.com"

    # Advanced TOTP configuration
    totp-advanced:
      plugin:
        totp-auth:
          secretKey: "JBSWY3DPEHPK3PXP"  # Replace with your secret
          sessionExpiry: 7200                # 2 hours
          cookieName: "secure_totp_session"
          cookieDomain: ".example.com"
          cookieSecure: true
          issuer: "MyCompany"
          accountName: "admin@company.com"
          timeStep: 30
          codeDigits: 6
          allowedSkew: 1
          validateIP: false                  # Set to true for stricter security (may break with proxies/NAT)
          pageTitle: "Secure Access Required"
          pageDescription: "Please enter your authentication code"

    # Short session for high-security areas
    totp-high-security:
      plugin:
        totp-auth:
          secretKey: "JBSWY3DPEHPK3PXP"  # Replace with your secret
          sessionExpiry: 900                 # 15 minutes
          validateIP: true                   # Strict IP validation for high security
          issuer: "Admin Panel"
          accountName: "admin"
          pageTitle: "Admin Authentication"
          pageDescription: "Enter code for admin access"

  routers:
    # Protected application
    secure-app:
      rule: "Host(`app.example.com`)"
      service: app-service
      middlewares:
        - totp-basic
      tls: {}

    # Admin panel with strict security
    admin-panel:
      rule: "Host(`admin.example.com`)"
      service: admin-service
      middlewares:
        - totp-high-security
      tls: {}

    # API with TOTP protection
    secure-api:
      rule: "Host(`api.example.com`) && PathPrefix(`/v1`)"
      service: api-service
      middlewares:
        - totp-advanced
      tls: {}

  services:
    app-service:
      loadBalancer:
        servers:
          - url: "http://app:8080"

    admin-service:
      loadBalancer:
        servers:
          - url: "http://admin:8080"

    api-service:
      loadBalancer:
        servers:
          - url: "http://api:8080"