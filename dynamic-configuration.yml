# Example Traefik Dynamic Configuration
# This file shows how to configure the TOTP authentication plugin

http:
  middlewares:
    # Basic TOTP authentication
    totp-basic:
      plugin:
        totp-auth:
          secretKey: "JBSWY3DPEHPK3PXP"  # Replace with your secret
          sessionExpiry: 3600
          issuer: "MyApp"
          accountName: "user@example.com"

    # Advanced TOTP configuration with trusted proxies
    totp-advanced:
      plugin:
        totp-auth:
          secretKey: "JBSWY3DPEHPK3PXP"  # Replace with your secret
          sessionExpiry: 7200                # 2 hours
          cookieName: "secure_totp_session"
          cookieDomain: ".example.com"
          cookieSecure: true
          issuer: "MyCompany"
          accountName: "admin@company.com"
          timeStep: 30
          codeDigits: 6
          allowedSkew: 1
          validateIP: true                   # Enable IP validation
          trustedProxies:                    # Trust these proxy IP ranges
            - "10.0.0.0/8"                   # Private network
            - "172.16.0.0/12"                # Private network
            - "192.168.0.0/16"               # Private network
          pageTitle: "Secure Access Required"
          pageDescription: "Please enter your authentication code"

    # Short session for high-security areas
    totp-high-security:
      plugin:
        totp-auth:
          secretKey: "JBSWY3DPEHPK3PXP"  # Replace with your secret
          sessionExpiry: 900                 # 15 minutes
          validateIP: true                   # Strict IP validation for high security
          issuer: "Admin Panel"
          accountName: "admin"
          pageTitle: "Admin Authentication"
          pageDescription: "Enter code for admin access"

    # Kubernetes/Cloud configuration with load balancer
    totp-kubernetes:
      plugin:
        totp-auth:
          secretKey: "JBSWY3DPEHPK3PXP"  # Replace with your secret
          sessionExpiry: 3600
          validateIP: true                   # Enable IP validation
          trustedProxies:                    # Trust load balancer/ingress IPs
            - "10.0.0.0/8"                   # Kubernetes pod network
            - "172.17.0.0/16"                # Docker bridge network
          issuer: "K8s Service"
          accountName: "user"

  routers:
    # Protected application
    secure-app:
      rule: "Host(`app.example.com`)"
      service: app-service
      middlewares:
        - totp-basic
      tls: {}

    # Admin panel with strict security
    admin-panel:
      rule: "Host(`admin.example.com`)"
      service: admin-service
      middlewares:
        - totp-high-security
      tls: {}

    # API with TOTP protection
    secure-api:
      rule: "Host(`api.example.com`) && PathPrefix(`/v1`)"
      service: api-service
      middlewares:
        - totp-advanced
      tls: {}

  services:
    app-service:
      loadBalancer:
        servers:
          - url: "http://app:8080"

    admin-service:
      loadBalancer:
        servers:
          - url: "http://admin:8080"

    api-service:
      loadBalancer:
        servers:
          - url: "http://api:8080"